#!/bin/bash -ex

# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
# SPDX-License-Identifier: Apache-2.0

greengrass_config="$(snapctl get greengrass-config)"
logger "aws-iot-greengrass::configure: validating config file: $greengrass_config"

# TODO: Add correct validation for config file
# Note - the current check only validates that a config file path has
# been specified, which is not considered an 'error', so 'exit 0' is
# used. Future validation logic should a non-zero exit code if a config
# file has been specified which is not valid (e.g. a malformed file).
if [ -z "$greengrass_config" ]; then
  logger "aws-iot-greengrass::configure: \"$greengrass_config\" is not a valid Greengrass config"
  exit 0
fi

# valid config and install has not been run
if [ ! -e "$SNAP_DATA/greengrass/v2" ]; then
    logger "aws-iot-greengrass::configure: running install"
    cd "$SNAP_DATA" || exit 1
    mkdir -p "$SNAP_DATA/greengrass/v2" || exit 2

    java -Droot="$SNAP_DATA/greengrass/v2" -Dlog.store=FILE -jar "$SNAP/lib/Greengrass.jar" \
      --start false --init-config "$greengrass_config" --component-default-user root:root || exit 3

    # TODO: rename greengrass to nucleus
    logger "aws-iot-greengrass::configure: enabling/starting nucleus!"
    snapctl start --enable $SNAP_NAME.greengrass
fi
